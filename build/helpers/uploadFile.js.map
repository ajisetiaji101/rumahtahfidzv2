{"version":3,"file":"uploadFile.js","names":["formidable","require","fs","config","uploadDir","process","cwd","uploadSingleFile","req","res","next","options","multiples","keepExtensions","maxFileSize","form","files","fields","onPart","part","filename","match","_handlePart","_error","Error","parse","on","fieldName","value","push","once","file","console","log","fileAttrb","uploadMultipleFile","showProductImage","params","url","createReadStream","responseNotFound","pipe","writeHead","end","module","exports"],"sources":["../../server/helpers/uploadFile.js"],"sourcesContent":["const formidable = require(\"formidable\");\r\nconst fs = require(\"fs\");\r\nconst config = require(\"../config/config\");\r\n\r\nconst uploadDir = process.cwd() + \"/storages/\";\r\n\r\nconst uploadSingleFile = async (req, res, next) => {\r\n  const options = {\r\n    multiples: false,\r\n    keepExtensions: true,\r\n    uploadDir: uploadDir,\r\n    maxFileSize: 50 * 1024 * 1024, // 5MB\r\n  };\r\n  const form = formidable(options);\r\n  let files = [];\r\n  let fields = [];\r\n\r\n  form.onPart = function (part) {\r\n    if (\r\n      !part.filename ||\r\n      part.filename.match(/\\.(jpg|jpeg|png|pdf|doc|docx)$/i)\r\n    ) {\r\n      this._handlePart(part);\r\n    } else {\r\n      form._error(new Error(\"File type is not supported\"));\r\n    }\r\n  };\r\n\r\n  form\r\n    .parse(req)\r\n    .on(\"field\", (fieldName, value) => {\r\n      fields.push({ fieldName, value });\r\n    })\r\n    .once(\"file\", (fieldName, file) => {\r\n      files.push({ fieldName, file });\r\n      //files = { ...{ fieldName, file } }\r\n    })\r\n    .once(\"end\", () => {\r\n      console.log(\"-> upload done\");\r\n      req.fileAttrb = {\r\n        files: files,\r\n        fields: fields,\r\n      };\r\n      next();\r\n    });\r\n};\r\n\r\nconst uploadMultipleFile = async (req, res, next) => {\r\n  const options = {\r\n    multiples: true,\r\n    keepExtensions: true,\r\n    uploadDir: uploadDir,\r\n    maxFileSize: 50 * 1024 * 1024, // 5MB\r\n  };\r\n  const form = formidable(options);\r\n  let files = [];\r\n  let fields = [];\r\n\r\n  // check tiap attribute\r\n  form.onPart = function (part) {\r\n    if (!part.filename || part.filename.match(/\\.(jpg|jpeg|png)$/i)) {\r\n      this._handlePart(part);\r\n    } else {\r\n      form._error(new Error(\"File type is not supported\"));\r\n    }\r\n  };\r\n\r\n  form\r\n    .parse(req)\r\n    .on(\"field\", (fieldName, value) => {\r\n      fields.push({ fieldName, value });\r\n    })\r\n    .on(\"file\", (fieldName, file) => {\r\n      files.push({ fieldName, file });\r\n      //files = { ...{ fieldName, file } }\r\n    })\r\n    .once(\"end\", () => {\r\n      console.log(\"-> upload done\");\r\n      req.fileAttrb = {\r\n        files: files,\r\n        fields: fields,\r\n      };\r\n      next();\r\n    });\r\n};\r\n\r\nconst showProductImage = async (req, res) => {\r\n  const filename = req.params.filename;\r\n  const url = `${process.cwd()}/storages/${filename}`;\r\n  fs.createReadStream(url)\r\n    .on(\"error\", () => responseNotFound(req, res))\r\n    .pipe(res);\r\n};\r\n\r\nfunction responseNotFound(req, res) {\r\n  res.writeHead(404, { \"Content-Type\": \"text/plain\" });\r\n  res.end(\"Not Found\");\r\n}\r\n\r\nmodule.exports = {\r\n  uploadSingleFile,\r\n  showProductImage,\r\n  uploadMultipleFile,\r\n};\r\n"],"mappings":"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"}